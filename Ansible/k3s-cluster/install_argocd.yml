---
- name: Installeer ArgoCD
  hosts: localhost
  connection: local
  tasks:
    - name: Maak ArgoCD namespace aan
      kubernetes.core.k8s:
        name: argocd
        api_version: v1
        kind: Namespace
        state: present

    - name: Download en installeer ArgoCD (Core installatie)
      kubernetes.core.k8s:
        state: present
        src: https://raw.githubusercontent.com/argoproj/argo-cd/v3.2.1/manifests/install.yaml
        namespace: argocd

    - name: Wacht tot ArgoCD pods starten 
      shell: kubectl wait --for=condition=Available deployment/argocd-server -n argocd --timeout=300s
      register: result
      ignore_errors: yes

    - name: Patch ArgoCD service naar LoadBalancer 
      shell: |
        kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'

# ... (Je eerdere taken die ArgoCD installeren met Helm/Manifests) ...

    - name: Wacht tot ArgoCD API server klaar is
      command: >
        kubectl wait --for=condition=Available deployment/argocd-server 
        -n argocd --timeout=300s
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: argocd_ready
      retries: 10
      delay: 30
      until: argocd_ready.rc == 0

    - name: Apply Root App (Bootstrap het cluster)
      command: kubectl apply -f https://raw.githubusercontent.com/Joe-designe/S3-eigenproject/main/Cluster/root-app.yaml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      when: argocd_ready.rc == 0