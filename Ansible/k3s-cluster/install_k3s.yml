---
- name: 1. Installeer K3s Master
  hosts: server
  become: true
  tasks:
    - name: Download en installeer K3s (Master)
      shell: curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Wacht tot K3s start
      wait_for:
        port: 6443
        delay: 5
        timeout: 300

    - name: Haal node-token op (voor workers)
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token_base64

    - name: Stel token vast
      set_fact:
        k3s_token: "{{ k3s_token_base64['content'] | b64decode | trim }}"

- name: 2. Installeer K3s Workers
  hosts: agent
  become: true
  tasks:
    - name: Join het cluster
      shell: "curl -sfL https://get.k3s.io | K3S_URL=https://{{ hostvars[groups['server'][0]]['inventory_hostname'] }}:6443 K3S_TOKEN={{ hostvars[groups['server'][0]]['k3s_token'] }} sh -"
      args:
        creates: /usr/local/bin/k3s-agent

- name: 3. Configureer Ansible VM en haal Config op
  hosts: server
  become: true
  tasks:
    # Dit haalt het bestand van de SERVER naar je ANSIBLE VM
    - name: Haal kubeconfig op naar Ansible VM
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ~/.kube/config
        flat: yes

- name: 4. Configureer lokaal kubectl (Ansible VM)
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    # --- STAP 1: Installeer kubectl ---
    - name: Download en installeer kubectl binary
      become: true
      get_url:
        url: "https://dl.k8s.io/release/v1.32.0/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'

    # --- STAP 2: Map voorbereiden ---
    # Zeker weten dat de map bestaat en de juiste rechten heeft voor JOUW user (niet root)
    - name: Maak .kube map aan in home directory
      file:
        path: ~/.kube
        state: directory
        mode: '0700'
    
    # --- STAP 3: Rechten goedzetten ---
    # Het bestand is door 'fetch' in Play 3 al neergezet, we hoeven alleen rechten te fixen
    - name: Pas rechten aan van config
      file:
        path: ~/.kube/config
        mode: '0600'

    # --- STAP 4: De Fix (IP adres aanpassen) ---
    - name: Wijzig 127.0.0.1 naar het echte Master IP
      replace:
        path: ~/.kube/config
        regexp: 'https://127.0.0.1:6443'
        # Hier gebruiken we ansible_host (het echte IP) in plaats van inventory_hostname (de naam)
        replace: "https://{{ hostvars[groups['server'][0]]['ansible_host'] | default(groups['server'][0]) }}:6443"