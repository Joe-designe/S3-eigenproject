---
- name: 1. Installeer K3s Master
  hosts: server
  become: true
  tasks:
    - name: Download en installeer K3s (Master)
      shell: curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Wacht tot K3s start
      wait_for:
        port: 6443
        delay: 5
        timeout: 300

    - name: Haal node-token op (voor workers)
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token_base64

    - name: Stel token vast
      set_fact:
        k3s_token: "{{ k3s_token_base64['content'] | b64decode | trim }}"

- name: 2. Installeer K3s Workers
  hosts: agent
  become: true
  tasks:
    - name: Join het cluster
      shell: "curl -sfL https://get.k3s.io | K3S_URL=https://{{ hostvars[groups['server'][0]]['inventory_hostname'] }}:6443 K3S_TOKEN={{ hostvars[groups['server'][0]]['k3s_token'] }} sh -"
      args:
        creates: /usr/local/bin/k3s-agent

- name: 3. Configureer Ansible VM als Controller
  hosts: server
  become: true
  tasks:
    - name: Haal kubeconfig op naar Ansible VM
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ~/.kube/config
        flat: yes

- name: 4. Configureer Ansible VM als Kubernetes Client
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    # --- STAP 1: Installeer kubectl (indien nodig) ---
    - name: Download en installeer kubectl binary
      become: true
      get_url:
        # We pakken hier een recente stabiele versie
        url: "https://dl.k8s.io/release/v1.32.0/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'

    # --- STAP 2: Map voorbereiden ---
    - name: Maak .kube map aan in home directory
      file:
        path: ~/.kube
        state: directory
        mode: '0700'

    # --- STAP 3: Config ophalen van de Master ---
    # We gebruiken hier 'delegate_to' om het bestand van de master (server) naar hier te trekken
    - name: Haal kubeconfig op van de master node
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ~/.kube/config
        flat: yes
      delegate_to: "{{ groups['server'][0] }}"
      become: true # Nodig om /etc/rancher/k3s/k3s.yaml te lezen op de master

    - name: Pas rechten aan van config (zodat jij hem mag lezen)
      file:
        path: ~/.kube/config
        mode: '0600'

    # --- STAP 4: De Fix (IP adres aanpassen) ---
    - name: Wijzig 127.0.0.1 naar het echte Master IP
      replace:
        path: ~/.kube/config
        # Zoek naar de localhost verwijzing die K3s er standaard in zet
        regexp: 'https://127.0.0.1:6443'
        # Vervang dit door het IP van de eerste server uit je inventory
        replace: "https://{{ hostvars[groups['server'][0]]['ansible_host'] | default(groups['server'][0]) }}:6443"